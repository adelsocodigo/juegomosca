<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ara√±a & Moscas ‚Äî Juego Pixel (Niveles..)</title>
  <meta name="description" content="Juego web en pixel art: ara√±a que come moscas, con niveles, avispas enemigas, m√∫sica y controles m√≥viles. Optimizado para m√≥vil y Netlify-ready." />
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --text: #e8f0ff;
      --muted: #9fb3c8;
      --accent: #5de4c7;
      --danger: #ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -200px, #142030 0%, var(--bg) 45%, #070a0e 100%);
      color: var(--text);
      display: grid; place-items: center;
    }

    .wrap { width: min(520px, 100vw); height: 100dvh; display: grid; grid-template-rows: auto 1fr auto; gap: 10px; padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom); }

    header { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(6px); }
    header .title { font-weight:700; letter-spacing:.3px; }
    header .score { font-variant-numeric: tabular-nums; }

    .stage { position:relative; }
    canvas { width: 100%; aspect-ratio: 4 / 5; image-rendering: pixelated; border-radius: var(--radius); background: #0b1119; border:1px solid rgba(255,255,255,.08); box-shadow: var(--shadow); touch-action: none; display:block; }

    .panel { position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
    .panel[hidden]{ display:none !important; }
    .card { pointer-events:auto; width:min(92%,520px); background: linear-gradient(180deg, #111826 0%, #0b1119 100%); border-radius: var(--radius); border:1px solid rgba(255,255,255,.08); box-shadow: var(--shadow); padding: 18px; text-align:center; }
    .card h1 { margin: 6px 0 8px; font-size: clamp(22px, 4.5vw, 28px); }
    .card p { margin: 6px 0 14px; color: var(--muted); }
    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

    .btn { appearance:none; border:0; padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:700; letter-spacing:.3px; background:var(--accent); color:#05241d; box-shadow:0 8px 20px rgba(93,228,199,.35); transition: transform .05s ease, filter .2s ease; user-select:none; }
    .btn:active { transform: translateY(1px) scale(.99); filter: brightness(.95); }
    .btn.secondary { background: #223042; color: var(--text); box-shadow: inset 0 0 0 1px rgba(255,255,255,.12); }

    .controls { display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top: 10px; }
    .ctrl { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; height: 64px; display:grid; place-items:center; font-weight:800; letter-spacing:1px; user-select:none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .ctrl:active { background: rgba(255,255,255,.08); }
    .ctrl span { pointer-events: none; }

    .opts { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:8px 0 0; }
    .opt { display:flex; align-items:center; gap:8px; font-size: 14px; color: var(--muted); }
    select, input[type=range] { background:#121a25; border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:10px; padding:6px 8px; }
    input[type=range] { width: 140px; }

    /* Controles m√≥viles persistentes */
    .mobile-controls { display:none; gap:8px; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 56px); justify-items:center; align-items:center; margin-top:8px; }
    .mobile-controls .mbtn { width:56px; height:56px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); display:grid; place-items:center; font-weight:800; letter-spacing:1px; -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select:none; font-size:18px; }
    .mobile-controls .mbtn:active { background: rgba(255,255,255,.1); }
    @media (hover: none), (pointer: coarse) { .mobile-controls { display:grid; } }
    .mobile-controls .mbtn { width:72px; height:72px; border-radius:18px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); display:grid; place-items:center; font-weight:800; letter-spacing:1px; -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select:none; font-size:20px; }
    .mobile-controls .mbtn:active { background: rgba(255,255,255,.1); }
    @media (hover: none), (pointer: coarse) { .mobile-controls { display:grid; } }
    .mobile-controls .mbtn { height:64px; border-radius:16px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); display:grid; place-items:center; font-weight:800; letter-spacing:1px; -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select:none; }
    .mobile-controls .mbtn:active { background: rgba(255,255,255,.1); }
    @media (hover: none), (pointer: coarse) { .mobile-controls { display:grid; } }

    footer { color: var(--muted); text-align:center; font-size: 12px; opacity: .9; }
    a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">üï∑Ô∏è Ara√±a & Moscas</div>
      <div class="score">Moscas comidas: <strong id="score">0</strong> ¬∑ Record: <strong id="best">0</strong></div>
    </header>

    <div class="stage">
      <canvas id="game" width="160" height="200" aria-label="Campo de juego pixel"></canvas>
      <div class="panel" id="overlay">
        <div class="card" role="dialog" aria-modal="true" aria-labelledby="ov-title">
          <h1 id="ov-title">Come moscas ‚Äî Niveles</h1>
          <p>Objetivo por nivel: come moscas para avanzar. Evita a las <strong>avispas</strong>. Toca/arrastra o usa ‚óÄ‚ñ≤‚ñº‚ñ∂. Pulsa <kbd>P</kbd> para pausar.</p>
          <div class="opts">
            <label class="opt">Inicio en
              <select id="startLevel">
                <option value="0" selected>F√°cil</option>
                <option value="1">Normal</option>
                <option value="2">Dif√≠cil</option>
              </select>
            </label>
            <label class="opt">Duraci√≥n <span id="durLbl">60s</span>
              <input id="duration" type="range" min="30" max="120" value="60" />
            </label>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="btnStart">Empezar</button>
            <button class="btn secondary" id="btnMute">üîä Sonido</button>
            <button class="btn secondary" id="btnMusic">üéµ M√∫sica</button>
          </div>
          <div class="controls" aria-hidden="true" style="margin-top:10px;">
            <div class="ctrl" id="left"><span>‚óÄÔ∏é</span></div>
            <div class="ctrl" id="up"><span>‚ñ≤</span></div>
            <div class="ctrl" id="right"><span>‚ñ∂Ô∏é</span></div>
            <div class="ctrl" style="grid-column: 2 / span 1;" id="down"><span>‚ñº</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controles t√°ctiles persistentes abajo -->
    <div class="mobile-controls" id="mobileControls" aria-label="Controles t√°ctiles">
      <div></div>
      <div class="mbtn" id="m-up">‚ñ≤</div>
      <div></div>
      <div class="mbtn" id="m-left">‚óÄÔ∏é</div>
      <div class="mbtn" id="m-pause">‚èØ</div>
      <div class="mbtn" id="m-right">‚ñ∂Ô∏é</div>
      <div></div>
      <div class="mbtn" id="m-down">‚ñº</div>
      <div></div>
    </div>

    </div>

    <footer>
      Pixel-art escalado (160√ó200). <span id="status"></span>
    </footer>
  </div>

  <script>
    // ======= Config de "mundo" pixel =======
    const VW = 160, VH = 200; // resoluci√≥n virtual
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    function fitCanvas() {
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      canvas.width = Math.round(VW * dpr);
      canvas.height = Math.round(VH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.imageSmoothingEnabled = false;
    }
    window.addEventListener('resize', fitCanvas);

    // ======= Estado =======
    const state = {
      running: false,
      paused: false,
      last: 0,
      score: 0,          // total de moscas comidas
      levelScore: 0,     // progreso en nivel actual
      best: Number(localStorage.getItem('bestSpiderScore') || 0),
      sound: true,
      music: true,
      timeLeft: 60_000, // ms
      tick: 0, // para animaciones
      lives: 5,
      inv: 0, // invencibilidad ms tras golpe
      levelIndex: 0,
      spider: { x: VW/2, y: VH/2, w: 12, h: 10, vx: 0, vy: 0, speed: 0.9 },
      wasps: [],
      flies: [],
      fx: [],
    };
    document.getElementById('best').textContent = state.best;

    // ======= Dificultad & niveles =======
    const DIFF = {
      easy:   { flySpeed: 0.20, spawn: 1100, spider: 0.95, fliesMax: 5,  waspSpeed: 0.45 },
      normal: { flySpeed: 0.30, spawn: 900,  spider: 1.00, fliesMax: 6,  waspSpeed: 0.60 },
      hard:   { flySpeed: 0.40, spawn: 750,  spider: 1.08, fliesMax: 7,  waspSpeed: 0.78 },
    };
    const LEVELS = [
      { name: 'F√°cil',   diffKey: 'easy',   target: 20, wasps: 1 },
      { name: 'Normal',  diffKey: 'normal', target: 25, wasps: 2 },
      { name: 'Dif√≠cil', diffKey: 'hard',   target: 30, wasps: 3 },
    ];

    // ======= Util =======
    const rnd = (a,b)=> a + Math.random()*(b-a);
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    function rectsOverlap(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

    // ======= Entrada =======
    const keys = new Set();
    window.addEventListener('keydown', e=>{
      if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','KeyW','KeyA','KeyS','KeyD','KeyP','Space','Enter'].includes(e.code)) e.preventDefault();
      keys.add(e.code);
    });
    window.addEventListener('keyup', e=> keys.delete(e.code));

    function pressDir(code,down=true){ if(down) keys.add(code); else keys.delete(code); }
    ;['left','right','up','down'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('pointerdown', ()=> pressDir('Arrow'+id[0].toUpperCase()+id.slice(1), true));
      el.addEventListener('pointerup',   ()=> pressDir('Arrow'+id[0].toUpperCase()+id.slice(1), false));
      el.addEventListener('pointerleave',()=> pressDir('Arrow'+id[0].toUpperCase()+id.slice(1), false));
    });

    // Controles t√°ctiles persistentes (m√≥vil)
    function bindControl(elId, code){
      const el = document.getElementById(elId);
      if(!el) return;
      el.addEventListener('pointerdown', ()=> keys.add(code));
      el.addEventListener('pointerup',   ()=> keys.delete(code));
      el.addEventListener('pointerleave',()=> keys.delete(code));
      el.addEventListener('touchstart', ()=> keys.add(code), {passive:true});
      el.addEventListener('touchend',   ()=> keys.delete(code));
    }
    bindControl('m-left','ArrowLeft');
    bindControl('m-right','ArrowRight');
    bindControl('m-up','ArrowUp');
    bindControl('m-down','ArrowDown');
    document.getElementById('m-pause').addEventListener('click', ()=> togglePause());

    canvas.addEventListener('touchstart', ()=> beep(880,0.01,'square',0.001), {passive:true});

    // ======= Audio minimal + m√∫sica arcade =======
    let audioCtx;
    let musicTimer = null, musicStep = 0;
    const MUSIC_TEMPO = 120; // BPM
    const SIXTEENTH_MS = 60000 / MUSIC_TEMPO / 4; // negra=beat
    const NOTES = { C5:523.25, D5:587.33, E5:659.25, G5:783.99, A5:880.00, B4:493.88, A4:440.00, G4:392.00, E4:329.63 };
    const MUSIC_SEQ = [ 'E5','E5','E5',null, 'E5','E5','E5',null, 'E5','G5','C5','D5','E5',null,null,null, 'G4','G4','G4',null, 'G4','E4','G4','A4','B4',null,null,null ];

    function ensureAudio(){ audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; }

    function playTone(freq, durMs, type='square', vol=0.06){
      try{
        const ctx = ensureAudio();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type; o.frequency.value = freq; g.gain.value = vol; o.connect(g); g.connect(ctx.destination);
        const now = ctx.currentTime;
        o.start(now);
        g.gain.setValueAtTime(vol, now);
        g.gain.exponentialRampToValueAtTime(0.0001, now + durMs/1000);
        o.stop(now + durMs/1000);
      }catch(e){ /* noop */ }
    }

    function startMusic(){
      if(!state.music || musicTimer) return;
      ensureAudio();
      stopMusic();
      musicStep = 0;
      const tick = ()=>{
        if(!state.running || state.paused || !state.music){ musicTimer = null; return; }
        const note = MUSIC_SEQ[musicStep % MUSIC_SEQ.length];
        if(note){ playTone(NOTES[note]||440, SIXTEENTH_MS*0.95, 'square', 0.04); }
        musicStep++;
        musicTimer = setTimeout(tick, SIXTEENTH_MS);
      };
      musicTimer = setTimeout(tick, 0);
    }
    function stopMusic(){ if(musicTimer){ clearTimeout(musicTimer); musicTimer = null; } }

    function beep(freq = 660, dur = 0.05, type = 'square', vol=0.12){
      if(!state.sound) return;
      try {
        ensureAudio();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.value = freq; g.gain.value = vol; o.connect(g); g.connect(audioCtx.destination);
        const now = audioCtx.currentTime || 0;
        o.start(now);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
        o.stop(now + dur);
      } catch(e){ /* noop */ }
    }

    // ======= Sprites en pixel =======
    function px(x,y,c){ ctx.fillStyle=c; ctx.fillRect(Math.round(x), Math.round(y), 1, 1); }

    function drawSpider(s){
      const ox = Math.round(s.x), oy = Math.round(s.y);
      const body = ['#131420','#1c1d2a','#26293a','#32354a'];
      for(let yy=-1; yy<=s.h; yy++){
        for(let xx=-1; xx<=s.w; xx++){
          const dx = (xx - s.w/2 + 0.5) / 6;
          const dy = (yy - s.h/2) / 5.2;
          const d2 = dx*dx + dy*dy;
          if(d2 <= 1){
            const shade = body[Math.min(body.length-1, Math.floor(d2*4))];
            px(ox+xx, oy+yy, shade);
          }
        }
      }
      for(let yy=-2; yy<2; yy++) for(let xx=3; xx<9; xx++) px(ox+xx, oy+yy, '#1d1f2c');
      px(ox+5, oy-2, '#f5f1d6'); px(ox+8, oy-2, '#f5f1d6');
      px(ox+5, oy-1, '#e65050'); px(ox+8, oy-1, '#e65050');
      px(ox+6, oy+1, '#f0f0f0'); px(ox+7, oy+1, '#f0f0f0');
      px(ox+6, oy+2, '#bfc3d6'); px(ox+7, oy+2, '#bfc3d6');
      px(ox+6, oy+3, '#0f0f17'); px(ox+7, oy+3, '#0f0f17');
      const legY = [1,3,5,7];
      for(let i=0;i<legY.length;i++){
        const y = oy + legY[i];
        const wobble = Math.round(Math.sin(state.tick*0.02 + i*0.5)*2);
        px(ox-3+wobble, y-1, '#07070f'); px(ox-2+wobble, y, '#0e0f19'); px(ox-1+wobble, y+1, '#0e0f19');
        px(ox+s.w+2-wobble, y-1, '#07070f'); px(ox+s.w+1-wobble, y, '#0e0f19'); px(ox+s.w-wobble, y+1, '#0e0f19');
      }
      px(ox+4, oy+1, '#3c3f55'); px(ox+8, oy+1, '#3c3f55');
      px(ox+5, oy, '#4a4f69'); px(ox+7, oy, '#4a4f69');
    }

    function drawFly(f){
      const ox = Math.round(f.x), oy = Math.round(f.y);
      px(ox, oy-1, '#e5f6ff'); px(ox+2, oy-1, '#e5f6ff');
      px(ox-1, oy, '#c5e5ff'); px(ox+3, oy, '#c5e5ff');
      px(ox-1, oy+1, '#a7cde8'); px(ox+3, oy+1, '#a7cde8');
      for(let yy=0; yy<3; yy++){
        for(let xx=0; xx<3; xx++){
          const base = ['#1c2b1f','#2f4b30','#3f7140'][yy];
          px(ox+xx, oy+yy, base);
        }
      }
      px(ox+1, oy+1, '#4f9a52');
      px(ox, oy+2, '#d45b5b'); px(ox+2, oy+2, '#d45b5b');
      px(ox+1, oy+3, '#131c13');
    }

    function drawWasp(w){
      const x = Math.round(w.x), y = Math.round(w.y);
      px(x+2,y+1,'#f2d048'); px(x+3,y+1,'#f2d048'); px(x+4,y+1,'#f2d048');
      px(x+1,y+2,'#2b2b34'); px(x+2,y+2,'#2b2b34'); px(x+3,y+2,'#f2d048'); px(x+4,y+2,'#2b2b34'); px(x+5,y+2,'#2b2b34');
      px(x+2,y+3,'#f2d048'); px(x+3,y+3,'#2b2b34'); px(x+4,y+3,'#f2d048');
      px(x,y+1,'#bfe5ff'); px(x+6,y+1,'#bfe5ff');
      px(x+6,y+3,'#2b2b34'); px(x+7,y+3,'#2b2b34');
      px(x+1,y+1,'#ffffff');
    }

    function drawParticle(p){ px(p.x, p.y, p.c); }

    // ======= Niveles =======
    function setupLevel(idx){
      state.levelIndex = idx;
      state.levelScore = 0;
      const L = LEVELS[state.levelIndex];
      const conf = DIFF[L.diffKey];
      state.timeLeft = Number(document.getElementById('duration').value)*1000;
      state.spider = { x: VW/2-6, y: VH-22, w: 12, h: 10, vx:0, vy:0, speed: conf.spider };
      state.wasps = [];
      for(let i=0;i<L.wasps;i++){
        const vx = (i%2===0? 1 : -1) * (conf.waspSpeed + i*0.06);
        const y = Math.round(VH*0.28 + i*14);
        state.wasps.push({ x: rnd(8,VW-20), y, w: 12, h: 6, vx });
      }
      state.flies.length = 0; state.fx.length = 0; spawnTimer = 0;
    }

    // ======= Juego =======
    let spawnTimer = 0;

    function reset(){
      state.score = 0; state.lives = 5; state.inv = 0; state.tick = 0;
      const startIdx = Number(document.getElementById('startLevel').value) || 0;
      setupLevel(startIdx);
      document.getElementById('score').textContent = state.score;
      document.getElementById('ov-title').textContent = `Come moscas ‚Äî Nivel ${LEVELS[state.levelIndex].name}`;
    }

    function spawnFly(){
      const L = LEVELS[state.levelIndex];
      const conf = DIFF[L.diffKey];
      const edge = Math.floor(Math.random()*4);
      let x=0,y=0,vx=0,vy=0; const s = conf.flySpeed;
      if(edge===0){ x = -4; y = rnd(10,VH-10); vx = s; }
      if(edge===1){ x = VW+4; y = rnd(10,VH-10); vx = -s; }
      if(edge===2){ y = -4; x = rnd(10,VW-10); vy = s; }
      if(edge===3){ y = VH+4; x = rnd(10,VW-10); vy = -s; }
      state.flies.push({ x, y, w:3, h:3, vx, vy });
      if(state.flies.length > conf.fliesMax) state.flies.shift();
    }

    function eat(x,y){
      for(let i=0;i<10;i++) state.fx.push({x: x+1+Math.random()*2, y: y+1+Math.random()*2, c:'#9dd3ff', life: 20});
      beep(880,0.06,'triangle',0.12);
    }

    function update(dt){
      state.tick += dt;
      const L = LEVELS[state.levelIndex];
      const conf = DIFF[L.diffKey];
      state.timeLeft -= dt; if(state.timeLeft <= 0){ return gameOver('¬°Tiempo agotado!'); }
      if(state.inv > 0) state.inv = Math.max(0, state.inv - dt);

      const s = state.spider;
      const acc = 0.08; const fr = 0.88; const maxv = 1.8*conf.spider;
      if(keys.has('ArrowLeft')||keys.has('KeyA')) s.vx -= acc;
      if(keys.has('ArrowRight')||keys.has('KeyD')) s.vx += acc;
      if(keys.has('ArrowUp')||keys.has('KeyW')) s.vy -= acc;
      if(keys.has('ArrowDown')||keys.has('KeyS')) s.vy += acc;
      s.vx *= fr; s.vy *= fr;
      s.vx = clamp(s.vx, -maxv, maxv); s.vy = clamp(s.vy, -maxv, maxv);
      s.x = clamp(s.x + s.vx, 4, VW - s.w - 4);
      s.y = clamp(s.y + s.vy, 8, VH - s.h - 4);

      for(const w of state.wasps){
        w.x += w.vx;
        if(w.x < 2){ w.x = 2; w.vx = Math.abs(w.vx); }
        if(w.x > VW - w.w - 2){ w.x = VW - w.w - 2; w.vx = -Math.abs(w.vx); }
        w.y += Math.sin((state.tick*0.003) + w.x*0.2)*0.05;
        if(state.inv===0 && rectsOverlap({x:s.x,y:s.y,w:s.w,h:s.h}, w)){
          state.lives -= 1; state.inv = 1500;
          beep(160,0.18,'square',0.22);
          s.x = VW/2-6; s.y = VH-20; s.vx = 0; s.vy = -0.5;
          if(state.lives <= 0){ return gameOver('GAME OVER'); }
        }
      }

      spawnTimer -= dt; if(spawnTimer <= 0){ spawnFly(); spawnTimer = conf.spawn; }
      for(const f of state.flies){ f.x += f.vx; f.y += f.vy; }
      for(let i=state.flies.length-1;i>=0;i--){ const f=state.flies[i]; if(f.x<-6||f.x>VW+6||f.y<-6||f.y>VH+6) state.flies.splice(i,1); }

      for(let i=state.flies.length-1;i>=0;i--){ const f=state.flies[i]; if(rectsOverlap({x:s.x,y:s.y,w:s.w,h:s.h}, f)){
        state.flies.splice(i,1); state.score++; state.levelScore++;
        document.getElementById('score').textContent = state.score; eat(f.x,f.y);
        state.timeLeft = Math.min(state.timeLeft + 1200, Number(document.getElementById('duration').value)*1000);
        if(state.levelScore >= L.target){
          if(state.levelIndex >= LEVELS.length-1){ return win(); }
          nextLevel(); return;
        }
      }}

      for(let i=state.fx.length-1;i>=0;i--){ const p=state.fx[i]; p.life--; if(p.life<=0) state.fx.splice(i,1); }
    }

    function nextLevel(){
      state.levelIndex++;
      const L = LEVELS[state.levelIndex];
      setupLevel(state.levelIndex);
      showOverlay(`Nivel superado`, `Pasas a <strong>${L.name}</strong>. Objetivo: ${L.target} moscas. Avispas: ${L.wasps}.`);
      beep(880,0.12,'sine',0.18);
      state.paused = true;
    }

    function win(){
      state.running = false;
      state.best = Math.max(state.best, state.score); localStorage.setItem('bestSpiderScore', String(state.best));
      document.getElementById('best').textContent = state.best;
      showOverlay('¬°Felicidades, ganaste la partida!','Total moscas: '+state.score+' ¬∑ Record: '+state.best);
      beep(1046,0.12,'triangle',0.2);
    }

    function gameOver(msg='GAME OVER'){
      state.running = false;
      state.best = Math.max(state.best, state.score); localStorage.setItem('bestSpiderScore', String(state.best));
      document.getElementById('best').textContent = state.best;
      showOverlay(msg, 'Puntos: '+state.score+' ¬∑ Record: '+state.best);
      beep(200,0.2,'sawtooth',0.18);
    }

    // ======= HUD =======
    function drawFlyIcon(x,y){
      px(x+1,y+1,'#e5f6ff'); px(x+3,y+1,'#e5f6ff');
      px(x,y+2,'#c5e5ff'); px(x+4,y+2,'#c5e5ff');
      px(x,y+3,'#a7cde8'); px(x+4,y+3,'#a7cde8');
      px(x+1,y+2,'#2f4b30'); px(x+2,y+2,'#3f7140'); px(x+3,y+2,'#2f4b30');
      px(x+2,y+3,'#4f9a52');
      px(x+1,y+4,'#d45b5b'); px(x+3,y+4,'#d45b5b');
    }
    function drawRoundedPanel(x,y,w,h){
      ctx.fillStyle = 'rgba(5,10,16,0.7)'; ctx.fillRect(x,y,w,h);
      ctx.strokeStyle = 'rgba(255,255,255,.18)'; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);
    }
    function drawHeart(x,y){
      px(x+1,y,'#ff6b6b'); px(x+4,y,'#ff6b6b');
      px(x,y+1,'#ff6b6b'); px(x+1,y+1,'#ff6b6b'); px(x+2,y+1,'#ff6b6b'); px(x+3,y+1,'#ff6b6b'); px(x+4,y+1,'#ff6b6b'); px(x+5,y+1,'#ff6b6b');
      px(x+1,y+2,'#ff6b6b'); px(x+2,y+2,'#ff6b6b'); px(x+3,y+2,'#ff6b6b'); px(x+4,y+2,'#ff6b6b');
      px(x+2,y+3,'#ff6b6b'); px(x+3,y+3,'#ff6b6b');
      px(x+2,y+4,'#ff6b6b');
    }
    function drawHUD(){
      ctx.fillStyle = '#e8f0ff'; ctx.fillRect(0,0,VW,6);
      const maxT = Number(document.getElementById('duration').value)*1000;
      ctx.fillStyle = '#5de4c7'; ctx.fillRect(0,0, (state.timeLeft / maxT)*VW, 6);
      let hx = 6, hy = 8; for(let i=0;i<state.lives;i++){ drawHeart(hx + i*10, hy); }
      const L = LEVELS[state.levelIndex];
      const text = `Lvl ${L.name}  ${String(state.levelScore).padStart(2,'0')}/${L.target}`;
      ctx.fillStyle = '#e8f0ff'; ctx.font = '8px monospace'; ctx.textBaseline = 'top';
      ctx.fillText(text, 6, 20);
      const panelW=58, panelH=14; const pxX = VW - panelW - 6, pxY = 8;
      drawRoundedPanel(pxX, pxY, panelW, panelH);
      drawFlyIcon(pxX+5, pxY+4);
      ctx.fillStyle = '#e8f0ff'; ctx.font = '8px monospace'; ctx.textBaseline = 'top';
      ctx.fillText(String(state.score).padStart(2,'0'), pxX+20, pxY+3);
    }

    // ======= Render =======
    function render(){
      ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width, canvas.height);
      ctx.setTransform(canvas.width/VW,0,0,canvas.height/VH,0,0); ctx.imageSmoothingEnabled = false;

      ctx.fillStyle = '#0b1119'; ctx.fillRect(0,0,VW,VH);
      ctx.globalAlpha = 0.08; ctx.fillStyle = '#92b5ff'; for(let y=0;y<VH;y+=8){ ctx.fillRect(0,y, VW,1); } ctx.globalAlpha = 1;

      for(const w of state.wasps) drawWasp(w);
      ctx.save(); if(state.inv>0 && ((state.tick/100|0)%2)) ctx.globalAlpha = 0.4; drawSpider(state.spider); ctx.restore();
      for(const f of state.flies) drawFly(f);
      for(const p of state.fx) drawParticle(p);

      drawHUD();

      ctx.strokeStyle = 'rgba(255,255,255,.15)'; ctx.strokeRect(0.5,0.5,VW-1,VH-1);
    }

    function loop(ts){
      if(!state.last) state.last = ts; const dt = Math.min(50, ts - state.last); state.last = ts;
      if(state.running && !state.paused){ update(dt); render(); requestAnimationFrame(loop); }
      else if(state.running && state.paused){ render(); requestAnimationFrame(loop); }
    }

    // ======= Flow =======
    function start(){
      reset(); hideOverlay(); fitCanvas(); state.running = true; state.paused = false; state.last = 0; render(); requestAnimationFrame(loop); beep(660,0.06,'sine',0.1);
      if(state.music) startMusic();
      document.getElementById('status').textContent = 'Jugando‚Ä¶';
    }

    function togglePause(){ if(!state.running) return; state.paused = !state.paused; document.getElementById('status').textContent = state.paused ? 'Pausado' : 'Jugando‚Ä¶'; showOverlay(state.paused? 'Pausa' : '', state.paused? `Puntos: ${state.score}` : ''); }

    function showOverlay(title, text){
      stopMusic();
      const ov = document.getElementById('overlay');
      ov.hidden = false; ov.style.display = 'grid'; ov.setAttribute('aria-hidden','false');
      document.getElementById('ov-title').textContent = title || 'Come moscas ‚Äî Niveles';
      const p = ov.querySelector('p'); if(text) p.innerHTML = text;
    }
    function hideOverlay(){
      const ov = document.getElementById('overlay');
      ov.hidden = true; ov.style.display = 'none'; ov.setAttribute('aria-hidden','true');
    }

    // ======= UI =======
    document.getElementById('btnStart').addEventListener('click', ()=>{ state.paused=false; start(); });
    const btnMute = document.getElementById('btnMute');
    btnMute.addEventListener('click', ()=>{ state.sound = !state.sound; btnMute.textContent = state.sound ? 'üîä Sonido' : 'üîá Silencio'; });
    const btnMusic = document.getElementById('btnMusic');
    btnMusic.addEventListener('click', ()=>{ state.music = !state.music; btnMusic.textContent = state.music ? 'üéµ M√∫sica' : 'üîá Sin m√∫sica'; if(state.music && state.running && !state.paused){ startMusic(); } else { stopMusic(); } });
    document.getElementById('duration').addEventListener('input', e=>{ document.getElementById('durLbl').textContent = e.target.value+'s'; });
    window.addEventListener('keydown', e=>{ if(e.code==='KeyP' || e.code==='Space') { e.preventDefault(); togglePause(); }});

    // ======= Tests (consola) =======
    function runTests(){
      try{
        console.log('%c[Tests] Iniciando‚Ä¶','color:#5de4c7');
        console.assert(rectsOverlap({x:0,y:0,w:10,h:10},{x:5,y:5,w:3,h:3}) === true, 'rects solapados deben ser true');
        console.assert(rectsOverlap({x:0,y:0,w:10,h:10},{x:20,y:20,w:3,h:3}) === false, 'rects separados deben ser false');
        console.assert(LEVELS.length===3 && LEVELS[0].target===20 && LEVELS[2].wasps===3, 'niveles definidos correctamente');
        console.assert(typeof DIFF.easy.flySpeed==='number' && typeof DIFF.hard.waspSpeed==='number', 'dif. contiene n√∫meros');
        console.assert(typeof beep==='function' && typeof startMusic==='function' && typeof stopMusic==='function', 'audio API disponible');
        console.log('%c[Tests] OK','color:#5de4c7');
      }catch(err){ console.error('[Tests] Fall√≥:', err); }
    }

    // Inicio (overlay visible por defecto)
    runTests();
    fitCanvas();
    render();
  </script>
</body>
</html>
